<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Product Detail</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Poppins:wght@400;500;600&family=SF+Pro+Display:wght@400;500&display=swap"
          rel="stylesheet"/>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <!-- bootstrap css -->
    <link rel="stylesheet" type="text/css" th:href="@{/css/bootstrap.min.css}">
    <!-- style css -->
    <link rel="stylesheet" type="text/css" th:href="@{/css/headertemplate.css}"/>
    <link rel="stylesheet" type="text/css" th:href="@{/css/footertemplate.css}"/>
    <style>
        .text-brown {
            color: #6F4E37;
        }

        .product-container {
            max-width: 1200px;
            margin: 30px auto;
            padding: 0 15px;
        }

        .product-image {
            width: 100%;
            aspect-ratio: 1;
            object-fit: cover;
            border-radius: 8px;
        }

        .product-title {
            font-family: "SF Pro Display", sans-serif;
            font-size: 26px;
            margin-bottom: 10px;
        }

        .product-price {
            font-family: "SF Pro Display", sans-serif;
            font-size: 24px;
            color: #F76D37;
            font-weight: 500;
            margin-bottom: 20px;
        }

        .options-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 15px;
        }

        .size-option, .topping-option {
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 8px 12px;
            cursor: pointer;
            font-size: 14px;
            background: white;
            min-width: 120px;
            text-align: center;
        }

        .size-option.selected, .topping-option.selected {
            border-color: #F76D37;
            background-color: #FFF5F2;
        }

        .option-section {
            margin-bottom: 20px;
        }

        .option-title {
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 10px;
            color: #333;
        }

        .btn-order {
            background-color: #F76D37;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            font-size: 14px;
        }

        .btn-order:hover {
            background-color: #E55D2B;
            color: white;
        }

        .btn-store {
            border: 1px solid #ddd;
            background-color: white;
            padding: 10px 20px;
            border-radius: 4px;
            font-size: 14px;
        }

        .btn-store:hover {
            background-color: #f8f9fa;
        }

        .product-description {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #eee;
        }

        .buttons-container {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .buttons-container button {
            flex: 1;
        }

        .profile-item {
            position: relative;
        }

        .logout-menu {
            display: none;
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            background-color: #fff;
            color: #000;
            padding: 8px 12px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            white-space: nowrap;
            z-index: 10;
        }

        .profile-item:hover .logout-menu {
            display: block;
        }

        .logout-link {
            text-decoration: none;
            color: #000;
            font-weight: bold;
        }
    </style>
</head>
<body>
<!-- Header section -->
<div th:replace="~{/header_template :: header_template}"></div>

<div class="product-container">
    <!-- Hidden input for product id -->
    <input type="hidden" id="productId" th:value="${product.id}">
    <div class="row">
        <!-- Product Image -->
        <div class="col-md-6 mb-4">
            <img th:src="${product.imageUrl != null ? product.imageUrl : '/images/default-product.jpg'}"
                 th:alt="${product.name}"
                 class="product-image">
        </div>

        <!-- Product Info -->
        <div class="col-md-6">
            <h1 class="product-title" th:text="${product.name}">Product Name</h1>
            <p class="product-price">
                <span th:text="${#numbers.formatDecimal(product.basePrice, 0, 'COMMA', 0, 'POINT')}">0</span>đ
            </p>

            <!-- Size Selection -->
            <div class="option-section" th:if="${product.sizes != null and !#lists.isEmpty(product.sizes)}">
                <div class="option-title">Select size (required)</div>
                <div class="options-grid">
                    <div th:each="size : ${product.sizes}"
                         class="size-option"
                         th:data-price="${size.price}"
                         th:data-name="${size.name}"
                         onclick="selectSize(this)">
                        <div th:text="${size.name}">Size name</div>
                        <div th:text="${'+' + #numbers.formatDecimal(size.price, 0, 'COMMA', 0, 'POINT') + 'đ'}">Price
                        </div>
                    </div>
                </div>
            </div>

            <!-- Toppings Selection -->
            <div class="option-section" th:if="${product.toppings != null and !#lists.isEmpty(product.toppings)}">
                <div class="option-title">Topping</div>
                <div class="options-grid">
                    <div th:each="topping : ${product.toppings}"
                         class="topping-option"
                         th:data-price="${topping.price}"
                         th:data-name="${topping.name}"
                         onclick="toggleTopping(this)">
                        <div th:text="${topping.name}">Topping name</div>
                        <div th:text="${'+' + #numbers.formatDecimal(topping.price, 0, 'COMMA', 0, 'POINT') + 'đ'}">
                            Price
                        </div>
                    </div>
                </div>
            </div>

            <div class="buttons-container">
                <button class="btn btn-order" onclick="addToCart()">Đặt giao tận nơi</button>
                <button class="btn btn-store" onclick="storeOrder()">Dùng tại quán</button>
            </div>
        </div>
    </div>

    <!-- Product Description -->
    <div class="product-description">
        <h4>Product description</h4>
        <p th:text="${product.description}">Product description</p>
    </div>
</div>
<div th:replace="~{/footer-template :: footer-template}"></div>
<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<!-- jQuery (nếu cần cho các script khác) -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<script>
    // Khởi tạo các biến toàn cục
    let basePrice = parseFloat(document.querySelector('.product-price span').textContent.replace(/,/g, ''));
    let selectedSize = null;
    let selectedToppings = new Set();

    function selectSize(element) {
        // Bỏ chọn tất cả size-option
        document.querySelectorAll('.size-option').forEach(el => el.classList.remove('selected'));
        element.classList.add('selected');
        selectedSize = {
            name: element.getAttribute('data-name'),
            price: parseFloat(element.getAttribute('data-price'))
        };
        updateTotalPrice();
    }

    function toggleTopping(element) {
        element.classList.toggle('selected');
        const name = element.getAttribute('data-name');
        const price = parseFloat(element.getAttribute('data-price'));

        if (element.classList.contains('selected')) {
            selectedToppings.add(JSON.stringify({name, price}));
        } else {
            // Xóa phần tử theo key đã chuyển sang dạng JSON string
            selectedToppings.forEach(item => {
                let parsed = JSON.parse(item);
                if (parsed.name === name) {
                    selectedToppings.delete(item);
                }
            });
        }
        updateTotalPrice();
    }

    function updateTotalPrice() {
        let total = basePrice;
        if (selectedSize) {
            total += selectedSize.price;
        }
        selectedToppings.forEach(item => {
            total += JSON.parse(item).price;
        });
        // Cập nhật lại giá hiển thị
        document.querySelector('.product-price span').textContent = total.toLocaleString();
    }

    // Hàm gọi API thêm sản phẩm vào giỏ hàng
    function addToCart() {
        // Kiểm tra chọn size nếu có yêu cầu
        const hasSizeOptions = document.querySelector('.size-option') !== null;
        if (hasSizeOptions && !document.querySelector('.size-option.selected')) {
            Swal.fire({
                title: "Thông báo",
                text: "Vui lòng chọn size trước khi đặt hàng",
                icon: "warning",
                timer: 3000,
                showConfirmButton: false
            });
            return;
        }

        // Lấy productId từ input hidden
        const productId = parseInt(document.getElementById('productId').value);
        if (isNaN(productId) || productId <= 0) {
            console.error("Invalid product ID:", productId);
            Swal.fire({
                title: "Lỗi",
                text: "Không thể xác định sản phẩm",
                icon: "error",
                timer: 3000,
                showConfirmButton: false
            });
            return;
        }

        // Chuẩn bị dữ liệu sizeInfo (nếu có)
        let sizeInfo = selectedSize ? JSON.stringify(selectedSize) : null;

        // Chuẩn bị dữ liệu toppingsInfo (nếu có)
        let toppingsInfo = selectedToppings.size > 0 ? JSON.stringify(
            Array.from(selectedToppings).map(item => JSON.parse(item))
        ) : null;

        // Tạo đối tượng cart item theo định dạng API
        const cartItem = {
            product: {
                id: productId
            },
            quantity: 1,
            sizeInfo: sizeInfo,
            toppingsInfo: toppingsInfo
        };

        console.log("Sending cart data:", JSON.stringify(cartItem, null, 2));

        // Gọi API để thêm vào giỏ hàng
        fetch('/api/cart', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Accept': 'application/json'
            },
            body: JSON.stringify(cartItem),
            credentials: 'include'
        })
            .then(response => {
                if (!response.ok) {
                    return response.text().then(text => {
                        console.error('Error response:', text);
                        throw new Error(`Server returned error: ${response.status}`);
                    });
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    Swal.fire({
                        title: "Thành công",
                        text: data.message || "Đã thêm sản phẩm vào giỏ hàng!",
                        icon: "success",
                        timer: 1500,
                        showConfirmButton: false
                    }).then(() => {
                        if (data.redirectUrl) {
//                                                        alert(data.redirectUrl);
                            window.location.href = data.redirectUrl;

                        }
                    });
                } else {
                    throw new Error(data.message || "Unknown error");
                }
            })
            .catch(error => {
                console.error('Error:', error);
                Swal.fire({
                    title: "Lỗi",
                    text: "Không thể thêm sản phẩm vào giỏ hàng: " + error.message,
                    icon: "error",
                    showConfirmButton: true
                });
            });
    }

    // Xử lý nút "Dùng tại quán"
    function storeOrder() {
        Swal.fire({
            title: "Thông báo",
            text: "Tính năng đang được phát triển",
            icon: "info",
            timer: 2000,
            showConfirmButton: false
        });
    }

    // Gán sự kiện cho các nút khi DOM sẵn sàng
    document.addEventListener('DOMContentLoaded', function () {
        // Các sự kiện đã được gán trực tiếp trong thẻ button thông qua thuộc tính onclick
    });
</script>
</body>
</html>
